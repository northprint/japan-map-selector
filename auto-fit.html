<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>自動調整地図</title>
  <style>
    body { margin: 20px; font-family: sans-serif; }
    svg { border: 1px solid #ccc; background: #f0f0f0; }
    .prefecture { fill: #e0e0e0; stroke: #999; stroke-width: 0.5; cursor: pointer; }
    .prefecture:hover { fill: #c0c0c0; }
    .municipality { fill: #f0f0f0; stroke: #aaa; stroke-width: 0.5; cursor: pointer; }
    .municipality:hover { fill: #d0d0d0; }
    #info { margin-top: 10px; padding: 10px; background: #fff; border: 1px solid #ddd; }
    button { padding: 8px 16px; margin: 5px; }
  </style>
</head>
<body>
  <h1>日本地図（自動調整版）</h1>
  <div>
    <button onclick="adjustView()">ビュー調整</button>
    <button onclick="zoomIn()">拡大</button>
    <button onclick="zoomOut()">縮小</button>
  </div>
  <svg id="map" width="800" height="600" viewBox="0 0 800 600"></svg>
  <div id="info">読み込み中...</div>
  
  <script type="module">
    const svg = document.getElementById('map');
    const info = document.getElementById('info');
    let selector;
    let currentScale = 30;
    let currentCenter = [138.0, 38.0];
    
    // モジュールを読み込み
    const module = await import('./dist/index.es.js');
    const { JapanMapSelector } = module;
    
    // インスタンス作成
    selector = new JapanMapSelector();
    
    // データ読み込み
    await selector.initialize(
      './src/data/prefectures.geojson',
      './src/data/municipalities.geojson'
    );
    
    // 境界を計算
    function calculateBounds() {
      let minLng = Infinity, maxLng = -Infinity;
      let minLat = Infinity, maxLat = -Infinity;
      
      const prefectures = selector.getPrefectures();
      prefectures.forEach(pref => {
        const [[west, south], [east, north]] = pref.bounds;
        minLng = Math.min(minLng, west);
        maxLng = Math.max(maxLng, east);
        minLat = Math.min(minLat, south);
        maxLat = Math.max(maxLat, north);
      });
      
      return { minLng, maxLng, minLat, maxLat };
    }
    
    // 地図を描画
    function render() {
      svg.innerHTML = '';
      
      const prefectures = selector.getPrefectures();
      const projection = {
        scale: currentScale,
        translateX: 400,
        translateY: 300,
        center: currentCenter
      };
      
      prefectures.forEach(prefecture => {
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        
        // パスデータを手動で生成
        const geometry = prefecture.feature.geometry;
        let pathData = '';
        
        if (geometry.type === 'MultiPolygon') {
          geometry.coordinates.forEach(polygon => {
            polygon.forEach(ring => {
              ring.forEach((coord, index) => {
                const lng = coord[0];
                const lat = coord[1];
                const x = (lng - projection.center[0]) * projection.scale + projection.translateX;
                const y = (-lat + projection.center[1]) * projection.scale + projection.translateY;
                
                if (index === 0) {
                  pathData += `M${x},${y} `;
                } else {
                  pathData += `L${x},${y} `;
                }
              });
              pathData += 'Z ';
            });
          });
        }
        
        path.setAttribute('d', pathData);
        path.setAttribute('class', 'prefecture');
        
        const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
        title.textContent = prefecture.name;
        path.appendChild(title);
        
        path.addEventListener('click', () => {
          info.textContent = `選択: ${prefecture.name}`;
        });
        
        svg.appendChild(path);
      });
      
      info.textContent = `表示完了 - スケール: ${currentScale}, 中心: [${currentCenter[0]}, ${currentCenter[1]}]`;
    }
    
    // ビューを自動調整
    window.adjustView = function() {
      const bounds = calculateBounds();
      const width = bounds.maxLng - bounds.minLng;
      const height = bounds.maxLat - bounds.minLat;
      
      currentCenter = [
        (bounds.minLng + bounds.maxLng) / 2,
        (bounds.minLat + bounds.maxLat) / 2
      ];
      
      // アスペクト比を考慮してスケールを計算
      const scaleX = 700 / width;
      const scaleY = 500 / height;
      currentScale = Math.min(scaleX, scaleY);
      
      info.textContent = `境界: 西${bounds.minLng.toFixed(1)}, 東${bounds.maxLng.toFixed(1)}, 南${bounds.minLat.toFixed(1)}, 北${bounds.maxLat.toFixed(1)}`;
      
      render();
    };
    
    window.zoomIn = function() {
      currentScale *= 1.2;
      render();
    };
    
    window.zoomOut = function() {
      currentScale /= 1.2;
      render();
    };
    
    // 初期表示
    adjustView();
  </script>
</body>
</html>