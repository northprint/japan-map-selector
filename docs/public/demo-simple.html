<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Japan Map Selector - Simple Demo</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    
    #map-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    #map-svg {
      background: #f8f8f8;
      width: 100%;
      height: 600px;
      border: 1px solid #e9ecef;
      border-radius: 4px;
    }
    
    .loading {
      text-align: center;
      padding: 50px;
    }
    
    .error {
      color: red;
      text-align: center;
      padding: 20px;
    }
    
    .info {
      margin-top: 10px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="map-container">
    <h1 style="text-align: center;">日本地図セレクター デモ</h1>
    <div id="status" class="loading">データを読み込んでいます...</div>
    <svg id="map-svg" viewBox="0 0 800 600" style="display: none;"></svg>
    <div id="info" class="info" style="display: none;"></div>
  </div>

  <script>
    // 状態管理
    let prefecturesData = null;
    let municipalitiesData = null;
    let selectedPrefecture = null;
    
    // UI要素
    const statusEl = document.getElementById('status');
    const svgEl = document.getElementById('map-svg');
    const infoEl = document.getElementById('info');
    
    // 座標変換（簡易メルカトル投影）
    function projectCoordinate(lon, lat) {
      // 日本の中心を基準に
      const centerLon = 138;
      const centerLat = 38;
      const scale = 100;
      
      const x = (lon - centerLon) * scale + 400;
      const y = -(lat - centerLat) * scale + 300;
      
      return [x, y];
    }
    
    // GeoJSONからSVGパスへ変換
    function geoJsonToPath(geometry) {
      let pathData = '';
      
      const processPolygon = (coordinates) => {
        coordinates.forEach((ring, ringIndex) => {
          ring.forEach((coord, index) => {
            const [x, y] = projectCoordinate(coord[0], coord[1]);
            if (index === 0) {
              pathData += `M ${x} ${y} `;
            } else {
              pathData += `L ${x} ${y} `;
            }
          });
          pathData += 'Z ';
        });
      };
      
      if (geometry.type === 'Polygon') {
        processPolygon(geometry.coordinates);
      } else if (geometry.type === 'MultiPolygon') {
        geometry.coordinates.forEach(polygon => {
          processPolygon(polygon);
        });
      }
      
      return pathData;
    }
    
    // 都道府県を描画
    function renderPrefectures() {
      svgEl.innerHTML = '';
      selectedPrefecture = null;
      infoEl.textContent = '都道府県をクリックして選択してください';
      
      if (!prefecturesData || !prefecturesData.features) {
        console.error('Prefecture data is invalid');
        return;
      }
      
      prefecturesData.features.forEach(feature => {
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        const pathData = geoJsonToPath(feature.geometry);
        
        if (pathData) {
          path.setAttribute('d', pathData);
          path.setAttribute('fill', '#ffffff');
          path.setAttribute('stroke', '#333333');
          path.setAttribute('stroke-width', '0.5');
          path.style.cursor = 'pointer';
          
          // ホバー効果
          path.addEventListener('mouseenter', () => {
            path.setAttribute('fill', '#e6f3ff');
          });
          
          path.addEventListener('mouseleave', () => {
            path.setAttribute('fill', '#ffffff');
          });
          
          // クリックイベント
          path.addEventListener('click', () => {
            const prefCode = feature.properties.N03_007?.substring(0, 2);
            const prefName = feature.properties.N03_001;
            
            if (prefCode && prefName) {
              selectedPrefecture = { code: prefCode, name: prefName };
              infoEl.textContent = `選択中: ${prefName}`;
              renderMunicipalities(prefCode);
            }
          });
          
          svgEl.appendChild(path);
        }
      });
    }
    
    // 市区町村を描画
    function renderMunicipalities(prefectureCode) {
      svgEl.innerHTML = '';
      
      // 戻るボタン
      const backGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      backGroup.style.cursor = 'pointer';
      
      const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      rect.setAttribute('x', '10');
      rect.setAttribute('y', '10');
      rect.setAttribute('width', '80');
      rect.setAttribute('height', '30');
      rect.setAttribute('fill', 'white');
      rect.setAttribute('stroke', '#333');
      rect.setAttribute('rx', '4');
      
      const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      text.setAttribute('x', '50');
      text.setAttribute('y', '30');
      text.setAttribute('text-anchor', 'middle');
      text.setAttribute('font-size', '14');
      text.textContent = '← 全国';
      
      backGroup.appendChild(rect);
      backGroup.appendChild(text);
      backGroup.addEventListener('click', renderPrefectures);
      svgEl.appendChild(backGroup);
      
      // 市区町村を描画
      const municipalities = municipalitiesData.features.filter(feature => {
        const code = feature.properties.N03_007;
        return code && code.substring(0, 2) === prefectureCode;
      });
      
      municipalities.forEach(feature => {
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        const pathData = geoJsonToPath(feature.geometry);
        
        if (pathData) {
          path.setAttribute('d', pathData);
          path.setAttribute('fill', '#f0f0f0');
          path.setAttribute('stroke', '#666666');
          path.setAttribute('stroke-width', '0.5');
          path.style.cursor = 'pointer';
          
          // ホバー効果
          path.addEventListener('mouseenter', () => {
            path.setAttribute('fill', '#e6f3ff');
          });
          
          path.addEventListener('mouseleave', () => {
            path.setAttribute('fill', '#f0f0f0');
          });
          
          // クリックイベント
          path.addEventListener('click', () => {
            const muniName = feature.properties.N03_004 || feature.properties.N03_003 || '';
            infoEl.textContent = `選択中: ${selectedPrefecture.name} - ${muniName}`;
          });
          
          svgEl.appendChild(path);
        }
      });
    }
    
    // データを読み込み
    async function loadData() {
      try {
        const baseUrl = 'https://raw.githubusercontent.com/northprint/japan-map-selector/main/src/data/simplified';
        
        const [prefRes, muniRes] = await Promise.all([
          fetch(`${baseUrl}/prefectures-low.geojson`),
          fetch(`${baseUrl}/municipalities-low.geojson`)
        ]);
        
        if (!prefRes.ok || !muniRes.ok) {
          throw new Error('Failed to load data');
        }
        
        prefecturesData = await prefRes.json();
        municipalitiesData = await muniRes.json();
        
        console.log('Data loaded:', {
          prefectures: prefecturesData.features.length,
          municipalities: municipalitiesData.features.length
        });
        
        // UIを更新
        statusEl.style.display = 'none';
        svgEl.style.display = 'block';
        infoEl.style.display = 'block';
        
        renderPrefectures();
        
      } catch (error) {
        console.error('Error loading data:', error);
        statusEl.innerHTML = '<div class="error">データの読み込みに失敗しました。<br>コンソールでエラーを確認してください。</div>';
      }
    }
    
    // 初期化
    loadData();
  </script>
</body>
</html>