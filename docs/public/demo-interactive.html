<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Japan Map Selector - Interactive Demo</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
      text-align: center;
    }
    
    #map-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .controls-panel {
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
      padding: 15px 20px;
      border-radius: 8px 8px 0 0;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .control-group label {
      font-size: 12px;
      color: #6c757d;
      font-weight: 600;
    }
    
    .control-group select {
      padding: 5px 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
      background: white;
    }
    
    .map-area {
      position: relative;
      padding: 20px;
      min-height: 600px;
    }
    
    #map-svg {
      background: #f8f8f8;
      width: 100%;
      height: 600px;
      border: 1px solid #e9ecef;
      border-radius: 4px;
    }
    
    .back-button {
      position: absolute;
      top: 30px;
      right: 30px;
      padding: 8px 16px;
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .back-button:hover {
      background: #f8f9fa;
    }
    
    .hover-info {
      position: absolute;
      bottom: 30px;
      left: 30px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
      pointer-events: none;
    }
    
    #selection-info {
      padding: 15px 20px;
      background: #f8f9fa;
      border-top: 1px solid #e9ecef;
      border-radius: 0 0 8px 8px;
    }
    
    #selection-info p {
      margin: 0;
      color: #495057;
    }
    
    .prefecture-path,
    .municipality-path {
      cursor: pointer;
      transition: fill 0.2s ease;
    }
    
    .prefecture-path:hover,
    .municipality-path:hover {
      opacity: 0.8;
    }
    
    .loading {
      text-align: center;
      padding: 50px;
    }
    
    .error-message {
      color: #dc3545;
      text-align: center;
      padding: 20px;
    }
  </style>
</head>
<body>
  <h1>日本地図セレクター - インタラクティブデモ</h1>
  
  <div id="map-container">
    <div class="controls-panel">
      <div class="control-group">
        <label>テーマ</label>
        <select id="theme-select">
          <option value="default">デフォルト</option>
          <option value="dark">ダーク</option>
          <option value="warm">ウォーム</option>
          <option value="cool">クール</option>
          <option value="monochrome">モノクローム</option>
        </select>
      </div>
    </div>
    
    <div class="map-area">
      <div id="map-loading" class="loading">
        <p>地図データを読み込んでいます...</p>
      </div>
      
      <svg id="map-svg" viewBox="0 0 800 600" style="display: none;"></svg>
      
      <button id="back-button" class="back-button" style="display: none;">
        ← 全国に戻る
      </button>
      
      <div id="hover-info" class="hover-info" style="display: none;"></div>
    </div>
    
    <div id="selection-info">
      <p>地図データを読み込んでいます...</p>
    </div>
  </div>

  <script>
    // テーマ定義
    const themes = {
      default: {
        prefectureFill: '#e8f4f8',
        prefectureStroke: '#4a90e2',
        prefectureHoverFill: '#d0e8f2',
        municipalityFill: '#f0f8ff',
        municipalityStroke: '#6b9bd1',
        municipalityHoverFill: '#e1f0ff',
        backgroundColor: '#ffffff'
      },
      dark: {
        prefectureFill: '#2c3e50',
        prefectureStroke: '#34495e',
        prefectureHoverFill: '#34495e',
        municipalityFill: '#3c5a7a',
        municipalityStroke: '#2c3e50',
        municipalityHoverFill: '#4a6fa5',
        backgroundColor: '#1a1a1a'
      },
      warm: {
        prefectureFill: '#ffe5d9',
        prefectureStroke: '#ff8c42',
        prefectureHoverFill: '#ffd4c1',
        municipalityFill: '#fff0e6',
        municipalityStroke: '#ffa65a',
        municipalityHoverFill: '#ffe0d1',
        backgroundColor: '#fffbf7'
      },
      cool: {
        prefectureFill: '#e3f2fd',
        prefectureStroke: '#1976d2',
        prefectureHoverFill: '#bbdefb',
        municipalityFill: '#f3f9ff',
        municipalityStroke: '#42a5f5',
        municipalityHoverFill: '#e1f5fe',
        backgroundColor: '#fafcff'
      },
      monochrome: {
        prefectureFill: '#f0f0f0',
        prefectureStroke: '#666666',
        prefectureHoverFill: '#e0e0e0',
        municipalityFill: '#f8f8f8',
        municipalityStroke: '#888888',
        municipalityHoverFill: '#eeeeee',
        backgroundColor: '#ffffff'
      }
    };

    // グローバル変数
    let currentTheme = themes.default;
    let prefecturesData = null;
    let municipalitiesData = null;
    let selectedPrefecture = null;
    let hoveredItem = null;

    // 要素の取得
    const svg = document.getElementById('map-svg');
    const loadingEl = document.getElementById('map-loading');
    const backButton = document.getElementById('back-button');
    const hoverInfo = document.getElementById('hover-info');
    const selectionInfo = document.getElementById('selection-info');
    const themeSelect = document.getElementById('theme-select');

    // データの読み込み
    async function loadData() {
      try {
        // GitHub Raw URLsからデータを読み込む
        const prefectureUrl = 'https://raw.githubusercontent.com/northprint/japan-map-selector/main/src/data/simplified/prefectures-low.geojson';
        const municipalityUrl = 'https://raw.githubusercontent.com/northprint/japan-map-selector/main/src/data/simplified/municipalities-low.geojson';

        const [prefRes, muniRes] = await Promise.all([
          fetch(prefectureUrl),
          fetch(municipalityUrl)
        ]);

        if (!prefRes.ok || !muniRes.ok) {
          throw new Error('データの読み込みに失敗しました');
        }

        prefecturesData = await prefRes.json();
        municipalitiesData = await muniRes.json();

        // UIを表示
        loadingEl.style.display = 'none';
        svg.style.display = 'block';
        selectionInfo.innerHTML = '<p>都道府県をクリックして選択してください。</p>';
        
        renderPrefectures();
      } catch (error) {
        console.error('Error loading data:', error);
        loadingEl.innerHTML = `<div class="error-message">データの読み込みに失敗しました。</div>`;
      }
    }

    // 都道府県の描画
    function renderPrefectures() {
      svg.innerHTML = '';
      svg.style.backgroundColor = currentTheme.backgroundColor;
      backButton.style.display = 'none';
      selectedPrefecture = null;

      prefecturesData.features.forEach(feature => {
        const path = createPath(feature, 'prefecture');
        svg.appendChild(path);
      });
    }

    // 市区町村の描画
    function renderMunicipalities(prefectureCode) {
      svg.innerHTML = '';
      backButton.style.display = 'block';

      // 選択された都道府県の市区町村のみフィルター
      const municipalities = municipalitiesData.features.filter(
        f => f.properties.prefecture_code === prefectureCode
      );

      // ViewBoxを調整
      const bounds = calculateBounds(municipalities);
      const padding = 20;
      svg.setAttribute('viewBox', 
        `${bounds.minX - padding} ${bounds.minY - padding} ${bounds.width + padding * 2} ${bounds.height + padding * 2}`
      );

      municipalities.forEach(feature => {
        const path = createPath(feature, 'municipality');
        svg.appendChild(path);
      });
    }

    // パスエレメントの作成
    function createPath(feature, type) {
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      const d = geoJsonToPath(feature.geometry);
      path.setAttribute('d', d);
      
      if (type === 'prefecture') {
        path.setAttribute('fill', currentTheme.prefectureFill);
        path.setAttribute('stroke', currentTheme.prefectureStroke);
        path.classList.add('prefecture-path');
        
        path.addEventListener('click', () => {
          selectedPrefecture = feature.properties;
          selectionInfo.innerHTML = `<p>選択中: <strong>${feature.properties.name}</strong></p>`;
          renderMunicipalities(feature.properties.code);
        });
        
        path.addEventListener('mouseenter', () => {
          path.setAttribute('fill', currentTheme.prefectureHoverFill);
          hoveredItem = feature.properties.name;
          updateHoverInfo();
        });
        
        path.addEventListener('mouseleave', () => {
          path.setAttribute('fill', currentTheme.prefectureFill);
          hoveredItem = null;
          updateHoverInfo();
        });
      } else {
        path.setAttribute('fill', currentTheme.municipalityFill);
        path.setAttribute('stroke', currentTheme.municipalityStroke);
        path.classList.add('municipality-path');
        
        path.addEventListener('click', () => {
          selectionInfo.innerHTML = `<p>選択中: <strong>${feature.properties.name}</strong></p>`;
        });
        
        path.addEventListener('mouseenter', () => {
          path.setAttribute('fill', currentTheme.municipalityHoverFill);
          hoveredItem = feature.properties.name;
          updateHoverInfo();
        });
        
        path.addEventListener('mouseleave', () => {
          path.setAttribute('fill', currentTheme.municipalityFill);
          hoveredItem = null;
          updateHoverInfo();
        });
      }
      
      path.setAttribute('stroke-width', '1');
      
      return path;
    }

    // GeoJSONをSVGパスに変換
    function geoJsonToPath(geometry) {
      let pathData = '';
      
      if (geometry.type === 'Polygon') {
        pathData = polygonToPath(geometry.coordinates);
      } else if (geometry.type === 'MultiPolygon') {
        geometry.coordinates.forEach(polygon => {
          pathData += polygonToPath(polygon) + ' ';
        });
      }
      
      return pathData.trim();
    }

    function polygonToPath(coordinates) {
      let path = '';
      coordinates.forEach((ring, index) => {
        ring.forEach((coord, i) => {
          const x = coord[0] * 10;
          const y = -coord[1] * 10 + 500;
          path += (i === 0 ? 'M' : 'L') + x + ',' + y + ' ';
        });
        path += 'Z ';
      });
      return path;
    }

    // 境界の計算
    function calculateBounds(features) {
      let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
      
      features.forEach(feature => {
        const processCoords = (coords) => {
          coords.forEach(coord => {
            if (Array.isArray(coord[0])) {
              processCoords(coord);
            } else {
              const x = coord[0] * 10;
              const y = -coord[1] * 10 + 500;
              minX = Math.min(minX, x);
              minY = Math.min(minY, y);
              maxX = Math.max(maxX, x);
              maxY = Math.max(maxY, y);
            }
          });
        };
        
        processCoords(feature.geometry.coordinates);
      });
      
      return {
        minX,
        minY,
        width: maxX - minX,
        height: maxY - minY
      };
    }

    // ホバー情報の更新
    function updateHoverInfo() {
      if (hoveredItem) {
        hoverInfo.style.display = 'block';
        hoverInfo.textContent = hoveredItem;
      } else {
        hoverInfo.style.display = 'none';
      }
    }

    // イベントリスナー
    backButton.addEventListener('click', () => {
      renderPrefectures();
      selectionInfo.innerHTML = '<p>都道府県をクリックして選択してください。</p>';
    });

    themeSelect.addEventListener('change', (e) => {
      currentTheme = themes[e.target.value];
      if (selectedPrefecture) {
        renderMunicipalities(selectedPrefecture.code);
      } else {
        renderPrefectures();
      }
    });

    // 初期化
    loadData();
  </script>
</body>
</html>