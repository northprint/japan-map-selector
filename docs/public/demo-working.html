<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Japan Map Selector - Demo</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    
    #map-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }
    
    #map-svg {
      background: #f8f8f8;
      width: 100%;
      height: 600px;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      display: block;
    }
    
    .loading {
      text-align: center;
      padding: 200px 20px;
      color: #666;
    }
    
    .error {
      color: #dc3545;
      text-align: center;
      padding: 200px 20px;
    }
    
    .info {
      margin-top: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 4px;
      text-align: center;
      color: #495057;
    }
    
    .back-btn {
      cursor: pointer;
    }
    
    .back-btn rect {
      fill: white;
      stroke: #333;
    }
    
    .back-btn:hover rect {
      fill: #f8f9fa;
    }
    
    .back-btn text {
      fill: #333;
      pointer-events: none;
    }
    
    path {
      cursor: pointer;
      transition: fill 0.2s;
    }
    
    .prefecture {
      fill: #ffffff;
      stroke: #333333;
      stroke-width: 0.5;
    }
    
    .prefecture:hover {
      fill: #e6f3ff;
    }
    
    .municipality {
      fill: #f0f0f0;
      stroke: #666666;
      stroke-width: 0.5;
    }
    
    .municipality:hover {
      fill: #e6f3ff;
    }
    
    /* 沖縄県用の特別なスタイル */
    .okinawa-frame {
      fill: white;
      stroke: #666;
      stroke-width: 2;
      stroke-dasharray: 5,5;
      pointer-events: none;
    }
    
    .okinawa-label {
      fill: #333;
      font-size: 14px;
      font-weight: bold;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="map-container">
    <h1>日本地図セレクター デモ</h1>
    <svg id="map-svg" viewBox="0 0 800 600">
      <text x="400" y="300" text-anchor="middle" class="loading">データを読み込んでいます...</text>
    </svg>
    <div id="info" class="info">地図データを読み込んでいます...</div>
  </div>

  <script>
    // グローバル変数
    let prefecturesData = null;
    let municipalitiesData = null;
    let selectedPrefecture = null;
    let currentView = 'japan'; // 'japan' or 'prefecture'
    
    // UI要素
    const svgEl = document.getElementById('map-svg');
    const infoEl = document.getElementById('info');
    
    // 日本地図用の投影設定
    const projection = {
      centerLon: 137.5,
      centerLat: 37.5,
      scale: 2500,
      translateX: 400,
      translateY: 300
    };
    
    // 座標変換
    function projectPoint(lon, lat) {
      const x = (lon - projection.centerLon) * projection.scale / 100 + projection.translateX;
      const y = -(lat - projection.centerLat) * projection.scale / 100 + projection.translateY;
      return [x, y];
    }
    
    // GeoJSONからSVGパスへ変換
    function geoJsonToPath(geometry) {
      let pathData = '';
      
      const processRing = (ring) => {
        ring.forEach((coord, index) => {
          const [x, y] = projectPoint(coord[0], coord[1]);
          pathData += (index === 0 ? 'M' : 'L') + x + ',' + y + ' ';
        });
        pathData += 'Z ';
      };
      
      if (geometry.type === 'Polygon') {
        geometry.coordinates.forEach(processRing);
      } else if (geometry.type === 'MultiPolygon') {
        geometry.coordinates.forEach(polygon => {
          polygon.forEach(processRing);
        });
      }
      
      return pathData;
    }
    
    // 都道府県コードと名前のマッピング
    const prefectureNames = {
      '01': '北海道', '02': '青森県', '03': '岩手県', '04': '宮城県', '05': '秋田県',
      '06': '山形県', '07': '福島県', '08': '茨城県', '09': '栃木県', '10': '群馬県',
      '11': '埼玉県', '12': '千葉県', '13': '東京都', '14': '神奈川県', '15': '新潟県',
      '16': '富山県', '17': '石川県', '18': '福井県', '19': '山梨県', '20': '長野県',
      '21': '岐阜県', '22': '静岡県', '23': '愛知県', '24': '三重県', '25': '滋賀県',
      '26': '京都府', '27': '大阪府', '28': '兵庫県', '29': '奈良県', '30': '和歌山県',
      '31': '鳥取県', '32': '島根県', '33': '岡山県', '34': '広島県', '35': '山口県',
      '36': '徳島県', '37': '香川県', '38': '愛媛県', '39': '高知県', '40': '福岡県',
      '41': '佐賀県', '42': '長崎県', '43': '熊本県', '44': '大分県', '45': '宮崎県',
      '46': '鹿児島県', '47': '沖縄県'
    };
    
    // 都道府県を描画
    function renderPrefectures() {
      svgEl.innerHTML = '';
      currentView = 'japan';
      selectedPrefecture = null;
      svgEl.setAttribute('viewBox', '0 0 800 600');
      infoEl.textContent = '都道府県をクリックして選択してください';
      
      // 沖縄県の枠を先に描画
      const okinawaFrame = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      
      const frameRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      frameRect.setAttribute('x', '120');
      frameRect.setAttribute('y', '50');
      frameRect.setAttribute('width', '180');
      frameRect.setAttribute('height', '140');
      frameRect.setAttribute('rx', '5');
      frameRect.setAttribute('ry', '5');
      frameRect.classList.add('okinawa-frame');
      
      const frameText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      frameText.setAttribute('x', '210');
      frameText.setAttribute('y', '70');
      frameText.setAttribute('text-anchor', 'middle');
      frameText.classList.add('okinawa-label');
      frameText.textContent = '沖縄県';
      
      okinawaFrame.appendChild(frameRect);
      okinawaFrame.appendChild(frameText);
      svgEl.appendChild(okinawaFrame);
      
      // 都道府県を描画
      prefecturesData.features.forEach(feature => {
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        let pathData;
        
        // 沖縄県の特別処理
        const prefCode = feature.properties.N03_007?.substring(0, 2);
        if (prefCode === '47') {
          // 沖縄県を左上に配置
          const originalPath = geoJsonToPath(feature.geometry);
          // 座標を変換（簡易的な方法）
          pathData = originalPath.replace(/([0-9.-]+),([0-9.-]+)/g, (match, x, y) => {
            const newX = (parseFloat(x) - 600) * 2 + 210;
            const newY = (parseFloat(y) - 200) * 2 + 120;
            return `${newX},${newY}`;
          });
        } else {
          pathData = geoJsonToPath(feature.geometry);
        }
        
        if (pathData) {
          path.setAttribute('d', pathData);
          path.classList.add('prefecture');
          
          // データ属性を設定
          path.dataset.code = prefCode;
          path.dataset.name = feature.properties.N03_001;
          
          // クリックイベント
          path.addEventListener('click', () => {
            if (prefCode && feature.properties.N03_001) {
              selectedPrefecture = {
                code: prefCode,
                name: feature.properties.N03_001
              };
              infoEl.textContent = `選択中: ${feature.properties.N03_001}`;
              renderMunicipalities(prefCode);
            }
          });
          
          svgEl.appendChild(path);
        }
      });
    }
    
    // 市区町村を描画
    function renderMunicipalities(prefectureCode) {
      svgEl.innerHTML = '';
      currentView = 'prefecture';
      
      // 戻るボタン
      const backBtn = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      backBtn.classList.add('back-btn');
      
      const btnRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      btnRect.setAttribute('x', '10');
      btnRect.setAttribute('y', '10');
      btnRect.setAttribute('width', '100');
      btnRect.setAttribute('height', '30');
      btnRect.setAttribute('rx', '4');
      
      const btnText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      btnText.setAttribute('x', '60');
      btnText.setAttribute('y', '30');
      btnText.setAttribute('text-anchor', 'middle');
      btnText.setAttribute('font-size', '14');
      btnText.textContent = '← 全国へ戻る';
      
      backBtn.appendChild(btnRect);
      backBtn.appendChild(btnText);
      backBtn.addEventListener('click', renderPrefectures);
      svgEl.appendChild(backBtn);
      
      // 選択された都道府県の市区町村をフィルター
      const municipalities = municipalitiesData.features.filter(feature => {
        const code = feature.properties.N03_007;
        return code && code.substring(0, 2) === prefectureCode;
      });
      
      // ViewBoxを計算
      let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
      municipalities.forEach(feature => {
        const pathData = geoJsonToPath(feature.geometry);
        // パスデータから境界を推定（簡易的）
        const coords = pathData.match(/([0-9.-]+),([0-9.-]+)/g);
        if (coords) {
          coords.forEach(coord => {
            const [x, y] = coord.split(',').map(parseFloat);
            minX = Math.min(minX, x);
            minY = Math.min(minY, y);
            maxX = Math.max(maxX, x);
            maxY = Math.max(maxY, y);
          });
        }
      });
      
      // ViewBoxを設定（余白を追加）
      const padding = 20;
      const width = maxX - minX + padding * 2;
      const height = maxY - minY + padding * 2;
      svgEl.setAttribute('viewBox', `${minX - padding} ${minY - padding} ${width} ${height}`);
      
      // 市区町村を描画
      municipalities.forEach(feature => {
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        const pathData = geoJsonToPath(feature.geometry);
        
        if (pathData) {
          path.setAttribute('d', pathData);
          path.classList.add('municipality');
          
          const muniName = feature.properties.N03_004 || feature.properties.N03_003 || '';
          
          // クリックイベント
          path.addEventListener('click', () => {
            infoEl.textContent = `選択中: ${selectedPrefecture.name} - ${muniName}`;
          });
          
          svgEl.appendChild(path);
        }
      });
    }
    
    // データを読み込み
    async function loadData() {
      try {
        const baseUrl = 'https://raw.githubusercontent.com/northprint/japan-map-selector/main/src/data/simplified';
        
        const [prefRes, muniRes] = await Promise.all([
          fetch(`${baseUrl}/prefectures-low.geojson`),
          fetch(`${baseUrl}/municipalities-low.geojson`)
        ]);
        
        if (!prefRes.ok || !muniRes.ok) {
          throw new Error('データの読み込みに失敗しました');
        }
        
        prefecturesData = await prefRes.json();
        municipalitiesData = await muniRes.json();
        
        console.log('Data loaded successfully:', {
          prefectures: prefecturesData.features.length,
          municipalities: municipalitiesData.features.length
        });
        
        // 都道府県を描画
        renderPrefectures();
        
      } catch (error) {
        console.error('Error:', error);
        svgEl.innerHTML = `<text x="400" y="300" text-anchor="middle" class="error">データの読み込みに失敗しました</text>`;
        infoEl.textContent = 'エラーが発生しました';
      }
    }
    
    // 初期化
    loadData();
  </script>
</body>
</html>